<!-- PROSES VALIDASI PENGGUNA -->
<!DOCTYPE html>
<html class="h-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
    <link href="css/riwayat.css" rel="stylesheet">
    <link rel="stylesheet" href="css/icons.css">
    <link rel="stylesheet" href="css/jquery.dataTables.min.css">
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery.js"></script>
    <title>
        SIPTADIK APK
    </title>
</head>

<body class="d-flex flex-column h-100">
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light warna-dasar sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/"><img class="d-inline-block align-middle me-1" src="./img/title.png" alt="" width="20" height="20"> <b class="d-inline-block align-middle">SIPTADIK</b></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/">Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="modal" data-bs-target="#modal_kontak">Profil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="/">Keluar</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- MODAL PROFIL -->
    <div class="modal fade" id="modal_kontak" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"><i class="bi bi-info-circle-fill"></i> Profil
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- ISI MODAL START HERE -->
                    <div class="row px-3 kontak">
                        <div class="col-lg-7 p-1 order-lg-1">
                            <!-- DETAIL PEJABAT -->

                            <div class="main-body">
                                <div class="row gutters-sm">
                                    <!-- FOTO PROFIL DAN MEDIA SOSIAL -->
                                    <div class="col-md-4 mb-3">
                                        <!-- FOTO PROFIL -->
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex flex-column align-items-center text-center">
                                                    <div class="detail-content-loader tunggu rounded-circle">
                                                        <img id="fotoProfil" src="" alt="Admin" class="rounded-circle" width="150" style="min-height: 150px;min-width: 150px;max-height: 150px;max-width: 150px">
                                                    </div>
                                                    <div class="mt-3">
                                                        <h4 class="namaProfil"></h4>
                                                        <p class="text-secondary mb-1 jabatanProfil"></p>
                                                        <p class="text-muted font-size-sm alamatProfil"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- DETAIL USER DAN STATISTIK -->
                                    <div class="col-md-8">
                                        <!-- DETAIL USER -->
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Nama Lengkap</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary namaProfil"></div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">NIP</h6>
                                                    </div>
                                                    <div id="nipProfil" class="col-sm-9 text-secondary">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Jabatan</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary jabatanProfil"></div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">No. Telepon</h6>
                                                    </div>
                                                    <div id="teleponProfil" class="col-sm-9 text-secondary">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Alamat</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary alamatProfil">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <a class="btn btn-success text-light" href="#" data-bs-toggle="modal" data-bs-target="#ubahdetail">Ubah</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- ISI MODAL END HERE -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL UBAH INFORMASI -->
    <div class="modal fade" id="ubahdetail" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form class="m-0 p-0" id="formUbahPejabat">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Ubah Data</h5>
                    </div>
                    <div class="modal-body">
                        <!-- ISI MODAL START HERE -->
                        <div class="row px-4">
                            <div class="mb-3">
                                <div class="form-group">
                                    <label class="required-field mb-1" for="pengguna_pjb"><i>Username</i></label>
                                    <input type="text" class="form-control" id="ubahUsername" placeholder="Nama pengguna" readonly value="">
                                    <div class="mt-1">
                                        <small class="text-danger"><i>Hanya lihat</i></small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-group">
                                    <label class="required-field mb-1" for="pass_pjb_1">Kata Sandi</label>
                                    <input name="sandi" id="ubahPassword" type="password" class="form-control pass" placeholder="Kata Sandi" value="">
                                    <div class="mt-1">
                                        <small class="text-danger"><i>Disarankan paduan huruf, angka dan/atau simbol</i></small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-group">
                                    <label class="required-field mb-1" for="nama_pjb">Nama Lengkap</label>
                                    <input name="nama" id="ubahNama" type="text" class="form-control" placeholder="Nama Lengkap" value="Syuaib">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-group">
                                    <label class="required-field mb-1" for="nip_pjb">NIP</label>
                                    <input name="nip" id="ubahNip" type="text" class="form-control" placeholder="NIP/NIK" value="" readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-group">
                                    <label class="required-field mb-1" for="foto_pjb">Foto Profil</label>
                                    <input name="foto" id="ubahFoto" type="file" class="form-control" accept=".png,.jpg,.jpeg">
                                    <div class="mt-1">
                                        <small class="text-danger">
                                            <i>Disarankan rasio 1:1 (persegi)</i>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-group">
                                    <label class="mb-1" for="hp_pjb">Nomor HP</label>
                                    <input name="nohp" id="ubahNomorHp" type="text" class="form-control" placeholder="Nomor Handphone" required value="+6288804263785">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-group">
                                    <label class="mb-1" for="alamat_pjb">Alamat</label>
                                    <input name="alamat" id="ubahAlamat" type="text" class="form-control" placeholder="Alamat Lengkap" required value="Jalan Andi Cammi Nomor 16">
                                </div>
                            </div>
                        </div>
                        <!-- ISI MODAL END HERE -->
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" name="ubahPejabat">Simpan</button>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modal_kontak">Keluar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- RIWAYAT -->
    <div class="container">
        <h2 class="my-4">Riwayat Tamu</h2>
        <div class="container mt-3 mb-4">
            <div class="col mt-4 mt-lg-0">
                <div class="row">
                    <div class="col-md-12">
                        <div class="user-dashboard-info-box table-responsive mb-0 bg-white p-4 shadow-sm">
                            <form class="bd-search position-relative me-auto mb-2">
                                <span class="algolia-autocomplete" style="position: relative; display: inline-block; direction: ltr;">
                                    <input type="search" class="form-control ds-input" id="search-input"
                                        placeholder="Cari..." aria-label="Cari..." autocomplete="off"
                                        data-bd-docs-version="5.1" spellcheck="false" role="combobox"
                                        aria-autocomplete="list" aria-expanded="false"
                                        aria-owns="algolia-autocomplete-listbox-0" dir="auto"
                                        style="position: relative; vertical-align: top;">
                                </span>
                            </form>
                            <!-- MAIN TABLE -->
                            <table class="table table-striped table-bordered manage-candidates-top">
                                <thead>
                                    <tr>
                                        <th scope="col">No</th>
                                        <th scope="col">Tanggal</th>
                                        <th scope="col">Nama Tamu</th>
                                        <th scope="col">Tujuan</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyRiwayat">

                                </tbody>
                            </table>
                            <!-- MODAL DETAIL TAMU -->
                            <div class="modal fade" id="modalDetailTamu" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header bg-warning bg-gradient text-dark fw-bold">
                                            <h5 class="modal-title" id="exampleModalLabel">Detail: Tamu Satu
                                            </h5>
                                        </div>
                                        <div class="modal-body">

                                            <div class="mb-2 row border-bottom" style="min-height: 250px;">
                                                <div class="col-sm-8 thumb text-center">
                                                    <img style="background-image: url('img/p.png'); background-size: cover;" id="detailFotoTamu" class="img-fluid" src="img/p.png">
                                                </div>
                                            </div>
                                            <div class="border rounded px-4 py-2">
                                                <div class="mb-2 row border-bottom">
                                                    <label class="col-sm-4 col-form-label fw-bold">Nama</label>
                                                    <div class="col-sm-8">
                                                        <p id="detailNamaTamu">tes nama</p>
                                                    </div>
                                                </div>
                                                <div class="mb-2 row border-bottom">
                                                    <label class="col-sm-4 col-form-label fw-bold">NIK/NIP</label>
                                                    <div class="col-sm-8">
                                                        <p id="detailNipTamu"></p>
                                                    </div>
                                                </div>
                                                <div class="mb-2 row border-bottom">
                                                    <label class="col-sm-4 col-form-label fw-bold">Instansi</label>
                                                    <div class="col-sm-8">
                                                        <p id="detailInstansiTamu"></p>
                                                    </div>
                                                </div>
                                                <div class="mb-2 row border-bottom">
                                                    <label class="col-sm-4 col-form-label fw-bold">Pejabat
                                                        Tujuan</label>
                                                    <div class="col-sm-8">
                                                        <p id="detailBidangTujuanTamu"></p>
                                                    </div>
                                                </div>
                                                <div class="mb-2 row">
                                                    <label class="col-sm-4 col-form-label fw-bold">Tujuan</label>
                                                    <div class="col-sm-8">
                                                        <p id="detailTujuanTamu"></p>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keluar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ISI SELESAI -->
    <script>
        const dataMentah = JSON.parse(localStorage.getItem('data'));


        // PROFIL
        function initJabatan(parmBidang, parmJabatan) {
            let jabatanUser = ""
            let bidangUser = ""
            let subbidangUser = ""

            dataMentah.dataRef.filter((item, index, full) => {
                if (item[0] === parmBidang) {
                    bidangUser = full[index][1]
                }
            })

            dataMentah.dataRef.filter((item, index, full) => {
                if (item[2] === parmBidang) {
                    subbidangUser = full[index][3]
                }
            })

            dataMentah.dataRef.filter((item, index, full) => {
                if (item[4] === parmJabatan) {
                    jabatanUser = full[index][5]
                }
            })

            let jabatanFinal = `${jabatanUser} ${subbidangUser} ${bidangUser}`

            if (bidangUser == "" && subbidangUser == "") {
                jabatanFinal = jabatanUser
            }
            return jabatanFinal;
        }

        $('#fotoProfil')[0].src = dataMentah.dataPjb[7]
        $('.namaProfil').text(dataMentah.dataPjb[3])
        $('.jabatanProfil').text(initJabatan(dataMentah.dataPjb[1], dataMentah.dataPjb[2]))
        $('.alamatProfil').text(dataMentah.dataPjb[6])
        $('#nipProfil').text(dataMentah.dataPjb[4])
        $('#teleponProfil').text(dataMentah.dataPjb[5])

        // UBAH PROFIL
        $('#ubahUsername').val(dataMentah.dataUser[0])
        $('#ubahPassword').val(dataMentah.dataUser[1])
            // $('#fotoProfil')[0].src = dataMentah.dataPjb[7]
        $('#ubahNama').val(dataMentah.dataPjb[3])
        $('#ubahAlamat').val(dataMentah.dataPjb[6])
        $('#ubahNip').val(dataMentah.dataPjb[4])
        $('#ubahNomorHp').val(dataMentah.dataPjb[5])

        $('#ubahFoto')

        $('#formUbahPejabat').submit(function(e) {
            const data = new FormData($('#formUbahPejabat')[0])
            const isi = Object.fromEntries(data.entries())
            warning("Ubah Profil", "Anda yakin akan mengubah profil?", function() {
                kirim(isi)
            })
            e.preventDefault()
        })

        function templateRiwayat(no, nama, tujuan, tanggal) {
            return templateTrRiwayat = `<tr class="trRiwayat">
                                            <th scope="row">${no}</th>
                                            <td>${tanggal}</td>
                                            <td>
                                                <a href="#">${nama}</a>
                                            </td>
                                            <td>${tujuan}</td>
                                        </tr>`
        }

        // MENGISI TABEL RIWAYAT
        for (let i = dataMentah.dataTamu.length - 1; i >= 0; i--) {
            const item = dataMentah.dataTamu[i];
            let tanggal = item[8].split("_", 3).join("/");
            let jam = item[8].split("_").slice(3, 6);
            let jamArr = jam;
            for (let j = 0; j < jam.length; j++) {
                if (jam[j].length == 1) {
                    jamArr[j] = "0" + jam[j];
                }
            }
            let jamFinal = jamArr.join(":");
            let waktuBertamu = `${tanggal} ${jamFinal}`

            $('#tbodyRiwayat').append(templateRiwayat(dataMentah.dataTamu.length - i, item[1], item[7], waktuBertamu))
        }

        // DETAIL TAMU
        let modalDetailTamu = new bootstrap.Modal(document.getElementById('modalDetailTamu'));
        $('.trRiwayat a').click(function(e) {
            let index = $('.trRiwayat a').length - $('.trRiwayat a').index(this) - 1
            $('#detailFotoTamu')[0].src = dataMentah.dataTamu[index][10]
            $('#detailNamaTamu').text(dataMentah.dataTamu[index][1])
            $('#detailNipTamu').text(dataMentah.dataTamu[index][2])
            $('#detailInstansiTamu').text(dataMentah.dataTamu[index][3])
            $('#detailBidangTujuanTamu').text(initJabatan(dataMentah.dataPjb[1], dataMentah.dataPjb[2]))
                // if (dataMentah.dataTamu[index][5] == "") {
                //     $('#detailBidangTujuanTamu').text(dataMentah.dataTamu[index][4])
                // }
            $('#detailTujuanTamu').text(dataMentah.dataTamu[index][7])

            modalDetailTamu.show()

            setTimeout(() => $('#modalDetailTamu svg').toggle(), 1000)

        })
    </script>
    <footer class="footer mt-auto py-3 warna-dasar">
        <div class="text-center">
            <small><i><a href="/" class="text-dark">SIPTADIK - Sistem Informasi Tamu</a> | Copyright &copy; 2021</i>
            </small>
        </div>
    </footer>
    <script src="js/main.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
</body>

</html>